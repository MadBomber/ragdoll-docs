
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../api-services/">
      
      
        <link rel="next" href="../background-processing/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Architecture Overview - Ragdoll Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#architecture-overview" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Ragdoll Documentation" class="md-header__button md-logo" aria-label="Ragdoll Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ragdoll Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Architecture Overview
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Ragdoll Documentation" class="md-nav__button md-logo" aria-label="Ragdoll Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Ragdoll Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ragdoll Documentation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Client API Reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-jobs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Jobs Reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Models Reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Services Reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Architecture Overview
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Architecture Overview
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#system-design-and-component-relationships" class="md-nav__link">
    <span class="md-ellipsis">
      System Design and Component Relationships
    </span>
  </a>
  
    <nav class="md-nav" aria-label="System Design and Component Relationships">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#high-level-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      High-Level Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-flow-through-the-system" class="md-nav__link">
    <span class="md-ellipsis">
      Data Flow Through the System
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data Flow Through the System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-document-ingestion-flow" class="md-nav__link">
    <span class="md-ellipsis">
      1. Document Ingestion Flow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-search-and-retrieval-flow" class="md-nav__link">
    <span class="md-ellipsis">
      2. Search and Retrieval Flow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-rag-enhancement-flow" class="md-nav__link">
    <span class="md-ellipsis">
      3. RAG Enhancement Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-points-with-external-services" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Points with External Services
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-components" class="md-nav__link">
    <span class="md-ellipsis">
      Core Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-client-interface-layer" class="md-nav__link">
    <span class="md-ellipsis">
      1. Client Interface Layer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-document-processing-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      2. Document Processing Pipeline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-embedding-generation-system" class="md-nav__link">
    <span class="md-ellipsis">
      3. Embedding Generation System
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-search-and-retrieval-engine" class="md-nav__link">
    <span class="md-ellipsis">
      4. Search and Retrieval Engine
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-database-abstraction-layer" class="md-nav__link">
    <span class="md-ellipsis">
      5. Database Abstraction Layer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-background-job-system" class="md-nav__link">
    <span class="md-ellipsis">
      6. Background Job System
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-decisions" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture Decisions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture Decisions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#choice-of-activerecord-for-orm" class="md-nav__link">
    <span class="md-ellipsis">
      Choice of ActiveRecord for ORM
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#polymorphic-multi-modal-design" class="md-nav__link">
    <span class="md-ellipsis">
      Polymorphic Multi-Modal Design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dual-metadata-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Dual Metadata Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#background-processing-approach" class="md-nav__link">
    <span class="md-ellipsis">
      Background Processing Approach
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vector-database-integration-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Vector Database Integration Strategy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#database-indexing-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Database Indexing Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async-processing-design" class="md-nav__link">
    <span class="md-ellipsis">
      Async Processing Design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caching-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Caching Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-and-observability" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring and Observability
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../background-processing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Background Processing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../database-schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database Schema
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Production Deployment Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Development Setup
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../document-processing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Document Processing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../embedding-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Embedding System
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../environment-variables/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Environment Variables Reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../extending/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extending the System
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../file-uploads/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    File Upload System
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation &amp; Setup
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../llm-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLM Integration
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../metadata-schemas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metadata Schemas
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Monitoring &amp; Analytics
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../multi-modal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-Modal Architecture
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../performance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Performance Tuning
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../search-analytics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Search &amp; Analytics
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security Considerations
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#system-design-and-component-relationships" class="md-nav__link">
    <span class="md-ellipsis">
      System Design and Component Relationships
    </span>
  </a>
  
    <nav class="md-nav" aria-label="System Design and Component Relationships">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#high-level-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      High-Level Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-flow-through-the-system" class="md-nav__link">
    <span class="md-ellipsis">
      Data Flow Through the System
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data Flow Through the System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-document-ingestion-flow" class="md-nav__link">
    <span class="md-ellipsis">
      1. Document Ingestion Flow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-search-and-retrieval-flow" class="md-nav__link">
    <span class="md-ellipsis">
      2. Search and Retrieval Flow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-rag-enhancement-flow" class="md-nav__link">
    <span class="md-ellipsis">
      3. RAG Enhancement Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-points-with-external-services" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Points with External Services
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-components" class="md-nav__link">
    <span class="md-ellipsis">
      Core Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-client-interface-layer" class="md-nav__link">
    <span class="md-ellipsis">
      1. Client Interface Layer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-document-processing-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      2. Document Processing Pipeline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-embedding-generation-system" class="md-nav__link">
    <span class="md-ellipsis">
      3. Embedding Generation System
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-search-and-retrieval-engine" class="md-nav__link">
    <span class="md-ellipsis">
      4. Search and Retrieval Engine
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-database-abstraction-layer" class="md-nav__link">
    <span class="md-ellipsis">
      5. Database Abstraction Layer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-background-job-system" class="md-nav__link">
    <span class="md-ellipsis">
      6. Background Job System
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-decisions" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture Decisions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture Decisions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#choice-of-activerecord-for-orm" class="md-nav__link">
    <span class="md-ellipsis">
      Choice of ActiveRecord for ORM
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#polymorphic-multi-modal-design" class="md-nav__link">
    <span class="md-ellipsis">
      Polymorphic Multi-Modal Design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dual-metadata-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Dual Metadata Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#background-processing-approach" class="md-nav__link">
    <span class="md-ellipsis">
      Background Processing Approach
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vector-database-integration-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Vector Database Integration Strategy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#database-indexing-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Database Indexing Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async-processing-design" class="md-nav__link">
    <span class="md-ellipsis">
      Async Processing Design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caching-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Caching Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-and-observability" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring and Observability
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="architecture-overview">Architecture Overview</h1>
<p>Ragdoll Core is a <strong>database-oriented RAG (Retrieval-Augmented Generation) framework</strong> built on ActiveRecord with PostgreSQL as the primary data store. The architecture follows a layered service-oriented design with clear separation of concerns, optimized for performance and extensibility.</p>
<h2 id="system-design-and-component-relationships">System Design and Component Relationships</h2>
<h3 id="high-level-architecture">High-Level Architecture</h3>
<pre><code class="language-mermaid">graph TB
    subgraph &quot;Client Interface Layer&quot;
        Client[Ragdoll::Core::Client&lt;br/&gt;üèóÔ∏è Facade Pattern]
        API[Public API Methods&lt;br/&gt;üîå High-level Interface]
        Delegation[Module Delegation&lt;br/&gt;üì° Method Forwarding]
    end

    subgraph &quot;Service Layer&quot;
        DocProc[Document Processor&lt;br/&gt;üìÑ Multi-format Parsing]
        DocMgmt[Document Management&lt;br/&gt;üóÇÔ∏è CRUD Operations]
        EmbedSvc[Embedding Service&lt;br/&gt;üß† Vector Generation]
        SearchEng[Search Engine&lt;br/&gt;üîç Semantic &amp; Hybrid Search]
        TextChunk[Text Chunker&lt;br/&gt;‚úÇÔ∏è Content Segmentation]
        TextGen[Text Generation Service&lt;br/&gt;üí¨ LLM Integration]
        Config[Configuration Manager&lt;br/&gt;‚öôÔ∏è Settings &amp; Providers]
    end

    subgraph &quot;Background Processing Layer&quot;
        ActiveJob[ActiveJob Integration&lt;br/&gt;‚ö° Queue Management]
        EmbedJob[Generate Embeddings Job&lt;br/&gt;üîÑ Async Processing]
        MetaJob[Metadata Generation Job&lt;br/&gt;üìä LLM Enhancement]
    end

    subgraph &quot;Data Layer&quot;
        DocModel[Document Model&lt;br/&gt;üìë Central Entity]
        TextContent[Text Content&lt;br/&gt;üìù Text Processing]
        ImageContent[Image Content&lt;br/&gt;üñºÔ∏è Image Analysis]
        AudioContent[Audio Content&lt;br/&gt;üéµ Audio Processing]
        EmbedModel[Embedding Model&lt;br/&gt;üéØ Vector Storage]
    end

    subgraph &quot;Infrastructure Layer&quot;
        PostgreSQL[(PostgreSQL + pgvector&lt;br/&gt;üêò Vector Database)]
        Shrine[Shrine File Storage&lt;br/&gt;üìÅ Upload Management]
        FullText[Full-text Search&lt;br/&gt;üîé GIN Indexes]
        VectorSearch[Vector Similarity&lt;br/&gt;üìê IVFFlat Indexes]
    end

    subgraph &quot;External Services&quot;
        LLMProviders[LLM Providers&lt;br/&gt;ü§ñ OpenAI, Anthropic, etc.]
        FileStorage[File Storage Backends&lt;br/&gt;‚òÅÔ∏è Local, S3, etc.]
    end

    %% Client Layer Connections
    Client --&gt; DocProc
    Client --&gt; DocMgmt
    Client --&gt; SearchEng
    Client --&gt; EmbedSvc
    API --&gt; Client
    Delegation --&gt; Client

    %% Service Layer Connections
    DocProc --&gt; TextChunk
    DocMgmt --&gt; DocProc
    DocMgmt --&gt; EmbedJob
    SearchEng --&gt; EmbedSvc
    EmbedSvc --&gt; LLMProviders
    TextGen --&gt; LLMProviders

    %% Background Processing
    EmbedJob --&gt; EmbedSvc
    EmbedJob --&gt; TextChunk
    MetaJob --&gt; TextGen
    ActiveJob --&gt; EmbedJob
    ActiveJob --&gt; MetaJob

    %% Data Layer Connections
    DocModel --&gt; TextContent
    DocModel --&gt; ImageContent
    DocModel --&gt; AudioContent
    TextContent --&gt; EmbedModel
    ImageContent --&gt; EmbedModel
    AudioContent --&gt; EmbedModel

    %% Infrastructure Connections
    DocModel --&gt; PostgreSQL
    EmbedModel --&gt; PostgreSQL
    EmbedModel --&gt; VectorSearch
    DocModel --&gt; FullText
    DocProc --&gt; Shrine
    Shrine --&gt; FileStorage
    VectorSearch --&gt; PostgreSQL
    FullText --&gt; PostgreSQL

    %% Styling
    classDef clientLayer fill:#e1f5fe
    classDef serviceLayer fill:#f3e5f5
    classDef processLayer fill:#fff3e0
    classDef dataLayer fill:#e8f5e8
    classDef infraLayer fill:#fce4ec
    classDef externalLayer fill:#f1f8e9

    class Client,API,Delegation clientLayer
    class DocProc,DocMgmt,EmbedSvc,SearchEng,TextChunk,TextGen,Config serviceLayer
    class ActiveJob,EmbedJob,MetaJob processLayer
    class DocModel,TextContent,ImageContent,AudioContent,EmbedModel dataLayer
    class PostgreSQL,Shrine,FullText,VectorSearch infraLayer
    class LLMProviders,FileStorage externalLayer
</code></pre>
<h3 id="data-flow-through-the-system">Data Flow Through the System</h3>
<h4 id="1-document-ingestion-flow">1. Document Ingestion Flow</h4>
<pre><code class="language-mermaid">sequenceDiagram
    participant User
    participant Client as Ragdoll::Core::Client
    participant DocProc as Document Processor
    participant Shrine as File Storage
    participant DB as PostgreSQL
    participant Job as Background Job
    participant EmbedSvc as Embedding Service
    participant LLM as LLM Provider

    User-&gt;&gt;Client: add_document(path)
    Client-&gt;&gt;DocProc: parse(file_path)
    Client-&gt;&gt;DocMgmt: add_document(path, content, metadata)
    DocMgmt-&gt;&gt;DB: store_document()
    DocMgmt--&gt;&gt;Client: return document_id
    Client--&gt;&gt;User: success response

    Client-&gt;&gt;Job: queue GenerateEmbeddings
    Job-&gt;&gt;EmbedSvc: process_document()
    EmbedSvc-&gt;&gt;LLM: generate_embeddings()
    LLM--&gt;&gt;EmbedSvc: vector_embeddings
    EmbedSvc-&gt;&gt;DB: store_embeddings()
    Job-&gt;&gt;DB: update_status(processed)
</code></pre>
<h4 id="2-search-and-retrieval-flow">2. Search and Retrieval Flow</h4>
<pre><code class="language-mermaid">flowchart TD
    A[Query Input] --&gt; B{Search Type?}

    B --&gt;|Semantic| C[Generate Query Embedding]
    B --&gt;|Full-text| D[PostgreSQL Text Search]
    B --&gt;|Hybrid| E[Both Semantic + Text]

    C --&gt; F[pgvector Similarity Search]
    D --&gt; G[GIN Index Search]
    E --&gt; H[Weighted Result Combination]

    F --&gt; I[Result Ranking]
    G --&gt; I
    H --&gt; I

    I --&gt; J[Usage Analytics Update]
    J --&gt; K[Context Assembly]
    K --&gt; L[Return Results]

    style A fill:#e1f5fe
    style L fill:#e8f5e8
    style I fill:#fff3e0
</code></pre>
<h4 id="3-rag-enhancement-flow">3. RAG Enhancement Flow</h4>
<pre><code class="language-mermaid">graph LR
    subgraph &quot;Context Retrieval&quot;
        A[User Prompt] --&gt; B[get_context]
        B --&gt; C[search_similar_content]
        C --&gt; D[Similarity Search]
        D --&gt; E[Top K Results]
    end

    subgraph &quot;Prompt Enhancement&quot;
        E --&gt; F[build_enhanced_prompt]
        F --&gt; G[Template Application]
        G --&gt; H[Context Integration]
    end

    subgraph &quot;Output Generation&quot;
        H --&gt; I[Enhanced Prompt]
        I --&gt; J[LLM Processing]
        J --&gt; K[Contextual Response]
    end

    style A fill:#e1f5fe
    style I fill:#fff3e0
    style K fill:#e8f5e8
</code></pre>
<h3 id="integration-points-with-external-services">Integration Points with External Services</h3>
<ul>
<li><strong>LLM Providers</strong>: OpenAI, Anthropic, Google, Azure, Ollama via <code>ruby_llm</code> gem</li>
<li><strong>File Storage</strong>: Shrine gem with configurable backends (filesystem, cloud storage)</li>
<li><strong>Background Processing</strong>: ActiveJob with multiple adapter support</li>
<li><strong>Search Extensions</strong>: Optional OpenSearch/Elasticsearch integration</li>
<li><strong>Monitoring</strong>: Built-in analytics and optional external monitoring tools</li>
</ul>
<h2 id="core-components">Core Components</h2>
<h3 id="1-client-interface-layer">1. Client Interface Layer</h3>
<p><strong>Primary Component</strong>: <code>Ragdoll::Core::Client</code></p>
<p><strong>Responsibilities</strong>:
- High-level API facade for all RAG operations
- Document lifecycle management (add, update, delete, list)
- Context retrieval and prompt enhancement
- Multi-modal search capabilities (semantic, hybrid, full-text)
- Health monitoring and system analytics</p>
<p><strong>Key Methods</strong>:</p>
<pre><code class="language-ruby"># Document Management
add_document(path:) ‚Üí result_hash
add_text(content:, title:, **options) ‚Üí document_id
add_directory(path:, recursive: false) ‚Üí results_array

# Search &amp; Retrieval
search(query:, **options) ‚Üí search_results
hybrid_search(query:, **options) ‚Üí weighted_results
get_context(query:, limit: 10, **options) ‚Üí context_hash
enhance_prompt(prompt:, context_limit: 5, **options) ‚Üí enhanced_prompt

# Analytics &amp; Health
stats() ‚Üí system_statistics
healthy?() ‚Üí boolean
search_analytics(days: 30) ‚Üí analytics_data
</code></pre>
<p><strong>Design Pattern</strong>: <strong>Facade Pattern</strong> - Simplifies complex subsystem interactions</p>
<h3 id="2-document-processing-pipeline">2. Document Processing Pipeline</h3>
<p><strong>Primary Component</strong>: <code>Ragdoll::Core::DocumentProcessor</code></p>
<p><strong>Responsibilities</strong>:
- Multi-format document parsing (PDF, DOCX, HTML, Markdown, Text)
- Content extraction and normalization
- Format-specific handling and validation
- Error handling for malformed documents</p>
<p><strong>Related Component</strong>: <code>Ragdoll::Core::DocumentManagement</code></p>
<p><strong>Responsibilities</strong>:
- Document CRUD operations (create, read, update, delete)
- Database persistence and retrieval
- Document metadata management
- Integration with background job processing</p>
<p><strong>Architecture Details</strong>:</p>
<pre><code class="language-ruby">class DocumentProcessor
  # Strategy pattern for format-specific parsing
  PARSERS = {
    '.pdf' =&gt; :parse_pdf,
    '.docx' =&gt; :parse_docx,
    '.html' =&gt; :parse_html,
    '.md' =&gt; :parse_markdown
  }.freeze

  def parse(file_path)
    # Returns structured result with content, metadata, and document_type
    {
      content: extracted_text,
      metadata: { title:, author:, creation_date:, ... },
      document_type: mime_type
    }
  end
end
</code></pre>
<p><strong>Architecture Details</strong>:</p>
<pre><code class="language-ruby">class DocumentManagement
  # Handles all document database operations
  def self.add_document(location, content, metadata = {})
    # Create document record with metadata
    # Returns document ID for further processing
  end

  def self.get_document(id)
    # Retrieve document with all associated content
  end

  def self.update_document(id, **updates)
    # Update document metadata and properties
  end
end
</code></pre>
<p><strong>Integration Points</strong>:
- DocumentProcessor for content parsing
- Background jobs for asynchronous processing
- ActiveRecord models for data persistence</p>
<h3 id="3-embedding-generation-system">3. Embedding Generation System</h3>
<p><strong>Primary Component</strong>: <code>Ragdoll::Core::EmbeddingService</code></p>
<p><strong>Responsibilities</strong>:
- Vector embedding generation using multiple LLM providers
- Text preprocessing and normalization
- Batch processing for efficiency
- Cosine similarity calculations
- Provider failover and error handling</p>
<p><strong>Provider Integration</strong>:</p>
<pre><code class="language-ruby">class EmbeddingService
  SUPPORTED_PROVIDERS = [
    :openai, :anthropic, :google, :azure, 
    :ollama, :huggingface, :openrouter
  ].freeze

  def generate_embedding(text)
    # Unified interface to multiple providers via ruby_llm
    @client.embed(text: clean_text(text))
  end

  def generate_embeddings_batch(texts)
    # Optimized batch processing
    texts.each_slice(batch_size).flat_map { |batch| process_batch(batch) }
  end
end
</code></pre>
<p><strong>Design Pattern</strong>: <strong>Adapter Pattern</strong> - Unifies diverse LLM provider APIs</p>
<h3 id="4-search-and-retrieval-engine">4. Search and Retrieval Engine</h3>
<p><strong>Primary Component</strong>: <code>Ragdoll::Core::SearchEngine</code></p>
<p><strong>Responsibilities</strong>:
- Semantic search using vector embeddings and pgvector
- Hybrid search combining semantic and full-text approaches
- Multi-modal content search across text, image, and audio
- Query embedding generation and similarity matching
- Search result ranking and relevance scoring</p>
<p><strong>Search Types</strong>:</p>
<ol>
<li><strong>Semantic Search</strong>: Vector similarity using cosine distance</li>
<li><strong>Hybrid Search</strong>: Combines semantic search with keyword extraction and filtering</li>
<li><strong>Content-Type Search</strong>: Specialized search for text, image, or audio content</li>
<li><strong>Filtered Search</strong>: Document-type and metadata-based filtering</li>
</ol>
<p><strong>Performance Optimizations</strong>:</p>
<pre><code class="language-ruby">class SearchEngine
  def search_similar_content(query, **options)
    # Generate query embedding for semantic search
    embedding = @embedding_service.generate_embedding(query)

    # Use pgvector for efficient similarity search
    Models::Embedding.search_similar(
      embedding,
      limit: options[:limit],
      threshold: options[:threshold],
      filters: options[:filters]
    )
  end

  def search_documents(query, options = {})
    # High-level search interface with filtering
    search_similar_content(query, options)
  end
end
</code></pre>
<h3 id="5-database-abstraction-layer">5. Database Abstraction Layer</h3>
<p><strong>Primary Component</strong>: <code>Ragdoll::Core::Database</code></p>
<p><strong>Responsibilities</strong>:
- Database connection management and health monitoring
- Automatic migration execution on startup
- Schema versioning and compatibility checks
- Development database reset capabilities
- Connection pooling optimization</p>
<p><strong>Key Features</strong>:</p>
<pre><code class="language-ruby">class Database
  def self.setup(config)
    establish_connection(config)
    run_migrations if config[:auto_migrate]
    verify_extensions  # Ensure pgvector is available
  end

  def self.healthy?
    connection.active? &amp;&amp; verify_schema_version
  rescue StandardError
    false
  end
end
</code></pre>
<h3 id="6-background-job-system">6. Background Job System</h3>
<p><strong>Primary Component</strong>: <code>Ragdoll::Core::Jobs::GenerateEmbeddings</code></p>
<p><strong>Responsibilities</strong>:
- Asynchronous embedding generation for new content
- LLM-powered metadata enhancement
- Text extraction and chunking for large documents
- Error handling and retry logic
- Progress tracking and status updates</p>
<p><strong>Job Architecture</strong>:</p>
<pre><code class="language-ruby">class GenerateEmbeddings &lt; ActiveJob::Base
  def perform(document_id)
    document = Models::Document.find(document_id)

    # Process each content type polymorphically
    document.content_items.each do |content|
      generate_embeddings_for_content(content)
    end

    document.update!(status: 'processed', processed_at: Time.current)
  end
end
</code></pre>
<p><strong>Design Pattern</strong>: <strong>Observer Pattern</strong> - Jobs triggered by model lifecycle events</p>
<h2 id="architecture-decisions">Architecture Decisions</h2>
<h3 id="choice-of-activerecord-for-orm">Choice of ActiveRecord for ORM</h3>
<p><strong>Decision</strong>: Use ActiveRecord as the primary ORM with PostgreSQL</p>
<p><strong>Rationale</strong>:
- <strong>Performance</strong>: Direct SQL generation with optimization capabilities
- <strong>Ecosystem</strong>: Rich plugin ecosystem (pgvector, full-text search)
- <strong>Migrations</strong>: Built-in schema versioning and migration management
- <strong>Associations</strong>: Powerful polymorphic associations for multi-modal content
- <strong>Connection Management</strong>: Built-in pooling and health monitoring</p>
<p><strong>Trade-offs</strong>:
- ‚úÖ Familiar Rails conventions and patterns
- ‚úÖ Excellent PostgreSQL integration
- ‚úÖ Rich querying capabilities with Arel
- ‚ùå Not database-agnostic (PostgreSQL-specific features used)
- ‚ùå Potential N+1 query issues (mitigated with careful includes)</p>
<h3 id="polymorphic-multi-modal-design">Polymorphic Multi-Modal Design</h3>
<p><strong>Decision</strong>: Use polymorphic associations for content types (text, image, audio)</p>
<p><strong>Rationale</strong>:
- <strong>Extensibility</strong>: Easy addition of new content types without schema changes
- <strong>Consistency</strong>: Unified embedding storage across all content types
- <strong>Performance</strong>: Single embedding table with efficient indexing
- <strong>Flexibility</strong>: Content-type specific processing while maintaining common interfaces</p>
<p><strong>Implementation</strong>:</p>
<pre><code class="language-ruby">class Document &lt; ActiveRecord::Base
  has_many :text_contents, dependent: :destroy
  has_many :image_contents, dependent: :destroy
  has_many :audio_contents, dependent: :destroy
end

class Embedding &lt; ActiveRecord::Base
  belongs_to :embeddable, polymorphic: true  # Text, Image, or Audio content
end
</code></pre>
<p><strong>Database Schema Relationships</strong>:</p>
<pre><code class="language-mermaid">erDiagram
    DOCUMENTS {
        uuid id PK
        string title
        string status
        jsonb metadata &quot;LLM-generated content analysis&quot;
        jsonb file_metadata &quot;System file properties&quot;
        text content &quot;Extracted text content&quot;
        string document_type
        timestamp created_at
        timestamp updated_at
        timestamp processed_at
    }

    TEXT_CONTENTS {
        uuid id PK
        uuid document_id FK
        text content
        integer chunk_index
        integer start_position
        integer end_position
        jsonb metadata
        timestamp created_at
        timestamp updated_at
    }

    IMAGE_CONTENTS {
        uuid id PK
        uuid document_id FK
        string file_data &quot;Shrine attachment&quot;
        string alt_text
        jsonb metadata &quot;Image analysis&quot;
        integer width
        integer height
        string format
        timestamp created_at
        timestamp updated_at
    }

    AUDIO_CONTENTS {
        uuid id PK
        uuid document_id FK
        string file_data &quot;Shrine attachment&quot;
        text transcript
        integer duration_seconds
        string format
        jsonb metadata &quot;Audio analysis&quot;
        timestamp created_at
        timestamp updated_at
    }

    EMBEDDINGS {
        uuid id PK
        uuid embeddable_id FK
        string embeddable_type &quot;Polymorphic type&quot;
        vector vector &quot;pgvector embedding&quot;
        string model_name
        integer vector_dimensions
        integer usage_count
        timestamp last_used_at
        timestamp created_at
        timestamp updated_at
    }

    %% Relationships
    DOCUMENTS ||--o{ TEXT_CONTENTS : &quot;has_many&quot;
    DOCUMENTS ||--o{ IMAGE_CONTENTS : &quot;has_many&quot;
    DOCUMENTS ||--o{ AUDIO_CONTENTS : &quot;has_many&quot;

    TEXT_CONTENTS ||--o{ EMBEDDINGS : &quot;embeddable (polymorphic)&quot;
    IMAGE_CONTENTS ||--o{ EMBEDDINGS : &quot;embeddable (polymorphic)&quot;
    AUDIO_CONTENTS ||--o{ EMBEDDINGS : &quot;embeddable (polymorphic)&quot;
</code></pre>
<h3 id="dual-metadata-architecture">Dual Metadata Architecture</h3>
<p><strong>Decision</strong>: Separate LLM-generated content metadata from file metadata</p>
<p><strong>Rationale</strong>:
- <strong>Separation of Concerns</strong>: Technical file properties vs. semantic content analysis
- <strong>Search Optimization</strong>: Different indexing strategies for different metadata types
- <strong>Cost Management</strong>: LLM metadata generation only when needed
- <strong>Extensibility</strong>: Easy addition of domain-specific metadata schemas</p>
<p><strong>Schema Design</strong>:</p>
<pre><code class="language-ruby">class Document &lt; ActiveRecord::Base
  # System-generated file properties
  store :file_metadata, accessors: [:file_size, :mime_type, :dimensions, :processing_params]

  # LLM-generated content analysis
  store :metadata, accessors: [:summary, :keywords, :classification, :topics, :sentiment]
end
</code></pre>
<h3 id="background-processing-approach">Background Processing Approach</h3>
<p><strong>Decision</strong>: Use ActiveJob with asynchronous embedding generation</p>
<p><strong>Rationale</strong>:
- <strong>User Experience</strong>: Non-blocking document upload and immediate response
- <strong>Resource Management</strong>: Controlled concurrency for expensive LLM operations
- <strong>Reliability</strong>: Retry logic and error handling for API failures
- <strong>Scalability</strong>: Horizontal scaling through job queue workers</p>
<p><strong>Error Handling Strategy</strong>:</p>
<pre><code class="language-ruby">class GenerateEmbeddings &lt; ActiveJob::Base
  retry_on EmbeddingService::APIError, wait: :exponentially_longer, attempts: 3
  discard_on EmbeddingService::InvalidInputError

  def perform(document_id)
    # Robust error handling with fallback strategies
  end
end
</code></pre>
<h3 id="vector-database-integration-strategy">Vector Database Integration Strategy</h3>
<p><strong>Decision</strong>: Use PostgreSQL + pgvector instead of dedicated vector databases</p>
<p><strong>Rationale</strong>:
- <strong>Simplicity</strong>: Single database system reduces operational complexity
- <strong>Performance</strong>: Native PostgreSQL optimizations with pgvector extension
- <strong>ACID Compliance</strong>: Transactional consistency between documents and embeddings
- <strong>Ecosystem</strong>: Leverages existing PostgreSQL tooling and expertise</p>
<p><strong>Performance Characteristics</strong>:
- <strong>IVFFlat Indexing</strong>: Sub-linear search performance O(log n)
- <strong>Concurrent Access</strong>: PostgreSQL's MVCC for high concurrency
- <strong>Memory Efficiency</strong>: Configurable vector dimensions and precision
- <strong>Backup/Recovery</strong>: Standard PostgreSQL tools work seamlessly</p>
<h2 id="performance-considerations">Performance Considerations</h2>
<h3 id="database-indexing-strategy">Database Indexing Strategy</h3>
<p><strong>Vector Indexes</strong>:</p>
<pre><code class="language-sql">-- IVFFlat index for similarity search
CREATE INDEX idx_embeddings_vector ON ragdoll_embeddings 
USING ivfflat (vector vector_cosine_ops) WITH (lists = 100);

-- Composite index for filtered searches
CREATE INDEX idx_embeddings_content_vector ON ragdoll_embeddings 
USING ivfflat (embeddable_type, vector vector_cosine_ops);
</code></pre>
<p><strong>Text Search Indexes</strong>:</p>
<pre><code class="language-sql">-- GIN index for full-text search
CREATE INDEX idx_documents_content_gin ON ragdoll_documents 
USING gin(to_tsvector('english', title || ' ' || coalesce(content, '')));

-- Metadata search optimization
CREATE INDEX idx_documents_metadata_gin ON ragdoll_documents 
USING gin(metadata);
</code></pre>
<p><strong>Performance Optimizations</strong>:</p>
<pre><code class="language-mermaid">graph TD
    subgraph &quot;Query Optimization&quot;
        A[Query Input] --&gt; B{Query Type}
        B --&gt;|Vector Similarity| C[IVFFlat Index]
        B --&gt;|Full-text Search| D[GIN Index]
        B --&gt;|Metadata Filter| E[JSON Index]

        C --&gt; F[pgvector Cosine Distance]
        D --&gt; G[PostgreSQL Text Ranking]
        E --&gt; H[JSON Path Queries]
    end

    subgraph &quot;Caching Strategy&quot;
        I[Frequently Used Embeddings] --&gt; J[In-Memory Cache]
        K[Search Results] --&gt; L[TTL-based Cache]
        M[Configuration] --&gt; N[Memoization]
    end

    subgraph &quot;Connection Management&quot;
        O[Multiple Clients] --&gt; P[Connection Pool]
        P --&gt; Q[Load Balancing]
        Q --&gt; R[Health Monitoring]
    end

    F --&gt; S[Result Ranking]
    G --&gt; S
    H --&gt; S
    S --&gt; T[Analytics Update]
    T --&gt; U[Optimized Results]

    style A fill:#e1f5fe
    style U fill:#e8f5e8
    style J fill:#fff3e0
    style P fill:#f3e5f5
</code></pre>
<p><strong>Implementation Details</strong>:
- <strong>Query Planning</strong>: Use of <code>EXPLAIN ANALYZE</code> for query optimization
- <strong>Index Maintenance</strong>: Regular <code>VACUUM</code> and <code>ANALYZE</code> operations
- <strong>Connection Pooling</strong>: ActiveRecord pool configuration for concurrency
- <strong>Prepared Statements</strong>: Automatic statement caching for repeated queries</p>
<h3 id="async-processing-design">Async Processing Design</h3>
<p><strong>Batch Processing</strong>:
- Embedding generation in configurable batch sizes (default: 10)
- Parallel processing of independent content items
- Memory management for large document processing</p>
<p><strong>Queue Management</strong>:</p>
<pre><code class="language-ruby"># Configuration for different job priorities
class GenerateEmbeddings &lt; ActiveJob::Base
  queue_as :embeddings

  # High priority for interactive operations
  def self.perform_now_if_small(document_id)
    document = Models::Document.find(document_id)
    if document.estimated_processing_time &lt; 5.seconds
      perform_now(document_id)
    else
      perform_later(document_id)
    end
  end
end
</code></pre>
<h3 id="caching-strategy">Caching Strategy</h3>
<p><strong>Application-Level Caching</strong>:
- Configuration memoization for frequently accessed settings
- Embedding result caching for repeated queries
- Search result caching with TTL-based invalidation</p>
<p><strong>Database-Level Optimization</strong>:
- Query result caching through PostgreSQL's shared buffers
- Materialized views for complex analytics queries
- Partial indexes for status-based filtering</p>
<p><strong>Memory Management</strong>:
- Streaming file processing for large documents
- Configurable chunk sizes balancing quality vs. performance
- Connection pool sizing based on concurrency requirements</p>
<h3 id="monitoring-and-observability">Monitoring and Observability</h3>
<p><strong>Built-in Analytics</strong>:
- Search frequency and result quality tracking
- Embedding generation performance metrics
- Document processing success/failure rates
- API response time monitoring</p>
<p><strong>Health Checks</strong>:</p>
<pre><code class="language-ruby">def healthy?
  checks = {
    database: Database.healthy?,
    embedding_service: @embedding_service.healthy?,
    job_queue: ActiveJob::Base.queue_adapter.healthy?
  }

  checks.all? { |_name, status| status }
end
</code></pre>
<p><strong>Performance Monitoring</strong>:
- Query execution time tracking
- Memory usage monitoring during document processing
- Background job queue depth monitoring
- LLM API latency and error rate tracking</p>
<hr />
<p><em>This document is part of the Ragdoll documentation suite. For immediate help, see the <a href="../quick-start/">Quick Start Guide</a> or <a href="../api-client/">API Reference</a>.</em></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  </body>
</html>