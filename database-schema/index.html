
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../contributing/">
      
      
        <link rel="next" href="../deployment/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Database Schema - Ragdoll Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#database-schema" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Ragdoll Documentation" class="md-header__button md-logo" aria-label="Ragdoll Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ragdoll Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Database Schema
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Ragdoll Documentation" class="md-nav__button md-logo" aria-label="Ragdoll Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Ragdoll Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ragdoll Documentation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Client API Reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-jobs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Jobs Reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Models Reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Services Reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../background-processing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Background Processing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Database Schema
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Database Schema
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#polymorphic-multi-modal-database-design" class="md-nav__link">
    <span class="md-ellipsis">
      Polymorphic Multi-Modal Database Design
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Polymorphic Multi-Modal Database Design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema-architecture-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Architecture Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-design-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Design Features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Key Design Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-table-inheritance-sti-for-content" class="md-nav__link">
    <span class="md-ellipsis">
      Single Table Inheritance (STI) for Content
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#polymorphic-embedding-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Polymorphic Embedding Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dual-metadata-system" class="md-nav__link">
    <span class="md-ellipsis">
      Dual Metadata System
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-tables" class="md-nav__link">
    <span class="md-ellipsis">
      Core Tables
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Tables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#documents-table-ragdoll_documents" class="md-nav__link">
    <span class="md-ellipsis">
      Documents Table (ragdoll_documents)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Documents Table (ragdoll_documents)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#column-details" class="md-nav__link">
    <span class="md-ellipsis">
      Column Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relationships" class="md-nav__link">
    <span class="md-ellipsis">
      Relationships
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#status-values" class="md-nav__link">
    <span class="md-ellipsis">
      Status Values
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contents-table-ragdoll_contents" class="md-nav__link">
    <span class="md-ellipsis">
      Contents Table (ragdoll_contents)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Contents Table (ragdoll_contents)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#content-types-sti" class="md-nav__link">
    <span class="md-ellipsis">
      Content Types (STI)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#technical-metadata-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Technical Metadata Examples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#embeddings-table-ragdoll_embeddings" class="md-nav__link">
    <span class="md-ellipsis">
      Embeddings Table (ragdoll_embeddings)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Embeddings Table (ragdoll_embeddings)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vector-storage-details" class="md-nav__link">
    <span class="md-ellipsis">
      Vector Storage Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#embedding-metadata-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Embedding Metadata Examples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#postgresql-extensions-table" class="md-nav__link">
    <span class="md-ellipsis">
      PostgreSQL Extensions Table
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#database-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Database Requirements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Database Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#postgresql-version-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      PostgreSQL Version Requirements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#required-extensions" class="md-nav__link">
    <span class="md-ellipsis">
      Required Extensions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Required Extensions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pgvector-extension-critical" class="md-nav__link">
    <span class="md-ellipsis">
      pgvector Extension (CRITICAL)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#text-processing-extensions" class="md-nav__link">
    <span class="md-ellipsis">
      Text Processing Extensions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Database Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Database Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#memory-settings" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Settings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connection-settings" class="md-nav__link">
    <span class="md-ellipsis">
      Connection Settings
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vector-search-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Vector Search Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#json-indexing" class="md-nav__link">
    <span class="md-ellipsis">
      JSON Indexing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#full-text-search-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Full-Text Search Optimization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#indexing-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Indexing Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Indexing Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vector-similarity-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Vector Similarity Indexes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Vector Similarity Indexes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ivfflat-index-for-embeddings" class="md-nav__link">
    <span class="md-ellipsis">
      IVFFlat Index for Embeddings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ivfflat-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      IVFFlat Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vector-index-maintenance" class="md-nav__link">
    <span class="md-ellipsis">
      Vector Index Maintenance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#full-text-search-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Full-Text Search Indexes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Full-Text Search Indexes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#document-full-text-index" class="md-nav__link">
    <span class="md-ellipsis">
      Document Full-Text Index
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#content-full-text-index" class="md-nav__link">
    <span class="md-ellipsis">
      Content Full-Text Index
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#full-text-search-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Full-Text Search Usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#json-metadata-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      JSON Metadata Indexes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="JSON Metadata Indexes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#classification-and-type-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Classification and Type Indexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#composite-json-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Composite JSON Indexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#array-and-complex-json-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Array and Complex JSON Indexes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-optimized-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Performance-Optimized Indexes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance-Optimized Indexes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#primary-key-and-foreign-key-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Primary Key and Foreign Key Indexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#composite-performance-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Composite Performance Indexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-based-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Time-Based Indexes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#index-maintenance-and-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Index Maintenance and Monitoring
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Index Maintenance and Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#index-usage-statistics" class="md-nav__link">
    <span class="md-ellipsis">
      Index Usage Statistics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#index-size-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Index Size Monitoring
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#index-maintenance-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Index Maintenance Commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#database-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      Database Migrations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Database Migrations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#migration-files-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Files Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auto-migration-feature" class="md-nav__link">
    <span class="md-ellipsis">
      Auto-Migration Feature
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Auto-Migration Feature">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#automatic-database-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Automatic Database Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-trigger-points" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Trigger Points
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manual-migration-process" class="md-nav__link">
    <span class="md-ellipsis">
      Manual Migration Process
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Manual Migration Process">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-migrations-manually" class="md-nav__link">
    <span class="md-ellipsis">
      Running Migrations Manually
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-migration-runner" class="md-nav__link">
    <span class="md-ellipsis">
      Custom Migration Runner
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema-versioning" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Versioning
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Schema Versioning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#migration-version-management" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Version Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema-version-tracking" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Version Tracking
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#version-compatibility-matrix" class="md-nav__link">
    <span class="md-ellipsis">
      Version Compatibility Matrix
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backward-compatibility" class="md-nav__link">
    <span class="md-ellipsis">
      Backward Compatibility
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backward Compatibility">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#migration-safety-features" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Safety Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-migration-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Data Migration Strategies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rollback-safety" class="md-nav__link">
    <span class="md-ellipsis">
      Rollback Safety
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Migration Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#development-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Development Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      Production Deployment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emergency-rollback-procedures" class="md-nav__link">
    <span class="md-ellipsis">
      Emergency Rollback Procedures
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#database-maintenance" class="md-nav__link">
    <span class="md-ellipsis">
      Database Maintenance
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Database Maintenance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#regular-maintenance-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      Regular Maintenance Tasks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Regular Maintenance Tasks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vacuum-and-analyze" class="md-nav__link">
    <span class="md-ellipsis">
      Vacuum and Analyze
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#index-maintenance" class="md-nav__link">
    <span class="md-ellipsis">
      Index Maintenance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Monitoring
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backup-and-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      Backup and Recovery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backup and Recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backup-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Backup Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recovery-procedures" class="md-nav__link">
    <span class="md-ellipsis">
      Recovery Procedures
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Production Deployment Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Development Setup
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../document-processing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Document Processing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../embedding-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Embedding System
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../environment-variables/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Environment Variables Reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../extending/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extending the System
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../file-uploads/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    File Upload System
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation &amp; Setup
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../llm-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLM Integration
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../metadata-schemas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metadata Schemas
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Monitoring &amp; Analytics
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../multi-modal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-Modal Architecture
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../performance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Performance Tuning
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../search-analytics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Search &amp; Analytics
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security Considerations
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#polymorphic-multi-modal-database-design" class="md-nav__link">
    <span class="md-ellipsis">
      Polymorphic Multi-Modal Database Design
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Polymorphic Multi-Modal Database Design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema-architecture-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Architecture Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-design-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Design Features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Key Design Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-table-inheritance-sti-for-content" class="md-nav__link">
    <span class="md-ellipsis">
      Single Table Inheritance (STI) for Content
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#polymorphic-embedding-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Polymorphic Embedding Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dual-metadata-system" class="md-nav__link">
    <span class="md-ellipsis">
      Dual Metadata System
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-tables" class="md-nav__link">
    <span class="md-ellipsis">
      Core Tables
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Tables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#documents-table-ragdoll_documents" class="md-nav__link">
    <span class="md-ellipsis">
      Documents Table (ragdoll_documents)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Documents Table (ragdoll_documents)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#column-details" class="md-nav__link">
    <span class="md-ellipsis">
      Column Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relationships" class="md-nav__link">
    <span class="md-ellipsis">
      Relationships
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#status-values" class="md-nav__link">
    <span class="md-ellipsis">
      Status Values
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contents-table-ragdoll_contents" class="md-nav__link">
    <span class="md-ellipsis">
      Contents Table (ragdoll_contents)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Contents Table (ragdoll_contents)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#content-types-sti" class="md-nav__link">
    <span class="md-ellipsis">
      Content Types (STI)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#technical-metadata-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Technical Metadata Examples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#embeddings-table-ragdoll_embeddings" class="md-nav__link">
    <span class="md-ellipsis">
      Embeddings Table (ragdoll_embeddings)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Embeddings Table (ragdoll_embeddings)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vector-storage-details" class="md-nav__link">
    <span class="md-ellipsis">
      Vector Storage Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#embedding-metadata-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Embedding Metadata Examples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#postgresql-extensions-table" class="md-nav__link">
    <span class="md-ellipsis">
      PostgreSQL Extensions Table
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#database-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Database Requirements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Database Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#postgresql-version-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      PostgreSQL Version Requirements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#required-extensions" class="md-nav__link">
    <span class="md-ellipsis">
      Required Extensions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Required Extensions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pgvector-extension-critical" class="md-nav__link">
    <span class="md-ellipsis">
      pgvector Extension (CRITICAL)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#text-processing-extensions" class="md-nav__link">
    <span class="md-ellipsis">
      Text Processing Extensions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Database Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Database Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#memory-settings" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Settings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connection-settings" class="md-nav__link">
    <span class="md-ellipsis">
      Connection Settings
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vector-search-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Vector Search Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#json-indexing" class="md-nav__link">
    <span class="md-ellipsis">
      JSON Indexing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#full-text-search-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Full-Text Search Optimization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#indexing-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Indexing Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Indexing Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vector-similarity-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Vector Similarity Indexes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Vector Similarity Indexes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ivfflat-index-for-embeddings" class="md-nav__link">
    <span class="md-ellipsis">
      IVFFlat Index for Embeddings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ivfflat-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      IVFFlat Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vector-index-maintenance" class="md-nav__link">
    <span class="md-ellipsis">
      Vector Index Maintenance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#full-text-search-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Full-Text Search Indexes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Full-Text Search Indexes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#document-full-text-index" class="md-nav__link">
    <span class="md-ellipsis">
      Document Full-Text Index
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#content-full-text-index" class="md-nav__link">
    <span class="md-ellipsis">
      Content Full-Text Index
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#full-text-search-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Full-Text Search Usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#json-metadata-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      JSON Metadata Indexes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="JSON Metadata Indexes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#classification-and-type-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Classification and Type Indexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#composite-json-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Composite JSON Indexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#array-and-complex-json-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Array and Complex JSON Indexes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-optimized-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Performance-Optimized Indexes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance-Optimized Indexes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#primary-key-and-foreign-key-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Primary Key and Foreign Key Indexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#composite-performance-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Composite Performance Indexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-based-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Time-Based Indexes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#index-maintenance-and-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Index Maintenance and Monitoring
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Index Maintenance and Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#index-usage-statistics" class="md-nav__link">
    <span class="md-ellipsis">
      Index Usage Statistics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#index-size-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Index Size Monitoring
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#index-maintenance-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Index Maintenance Commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#database-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      Database Migrations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Database Migrations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#migration-files-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Files Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auto-migration-feature" class="md-nav__link">
    <span class="md-ellipsis">
      Auto-Migration Feature
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Auto-Migration Feature">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#automatic-database-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Automatic Database Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-trigger-points" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Trigger Points
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manual-migration-process" class="md-nav__link">
    <span class="md-ellipsis">
      Manual Migration Process
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Manual Migration Process">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-migrations-manually" class="md-nav__link">
    <span class="md-ellipsis">
      Running Migrations Manually
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-migration-runner" class="md-nav__link">
    <span class="md-ellipsis">
      Custom Migration Runner
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema-versioning" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Versioning
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Schema Versioning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#migration-version-management" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Version Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema-version-tracking" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Version Tracking
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#version-compatibility-matrix" class="md-nav__link">
    <span class="md-ellipsis">
      Version Compatibility Matrix
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backward-compatibility" class="md-nav__link">
    <span class="md-ellipsis">
      Backward Compatibility
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backward Compatibility">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#migration-safety-features" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Safety Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-migration-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Data Migration Strategies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rollback-safety" class="md-nav__link">
    <span class="md-ellipsis">
      Rollback Safety
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Migration Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#development-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Development Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      Production Deployment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emergency-rollback-procedures" class="md-nav__link">
    <span class="md-ellipsis">
      Emergency Rollback Procedures
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#database-maintenance" class="md-nav__link">
    <span class="md-ellipsis">
      Database Maintenance
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Database Maintenance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#regular-maintenance-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      Regular Maintenance Tasks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Regular Maintenance Tasks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vacuum-and-analyze" class="md-nav__link">
    <span class="md-ellipsis">
      Vacuum and Analyze
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#index-maintenance" class="md-nav__link">
    <span class="md-ellipsis">
      Index Maintenance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Monitoring
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backup-and-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      Backup and Recovery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backup and Recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backup-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Backup Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recovery-procedures" class="md-nav__link">
    <span class="md-ellipsis">
      Recovery Procedures
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="database-schema">Database Schema</h1>
<p>Ragdoll implements a sophisticated PostgreSQL database schema designed for high-performance vector similarity search and multi-modal content management. The schema uses polymorphic associations, Single Table Inheritance (STI), and advanced PostgreSQL features including pgvector for embedding storage.</p>
<h2 id="polymorphic-multi-modal-database-design">Polymorphic Multi-Modal Database Design</h2>
<p>The database architecture is built around three core principles:</p>
<ol>
<li><strong>Multi-Modal Content Support</strong>: Single schema handles text, images, audio, and mixed content</li>
<li><strong>Polymorphic Embeddings</strong>: Vector embeddings can be associated with any content type</li>
<li><strong>Performance Optimization</strong>: Advanced indexing strategies for both vector and full-text search</li>
</ol>
<h3 id="schema-architecture-overview">Schema Architecture Overview</h3>
<pre><code class="language-mermaid">erDiagram
    DOCUMENTS {
        bigint id PK
        string location UK
        string title
        text summary
        text keywords
        string document_type
        string status
        json metadata
        timestamp file_modified_at
        timestamp created_at
        timestamp updated_at
    }

    CONTENTS {
        bigint id PK
        string type
        bigint document_id FK
        string embedding_model
        text content
        text data
        json metadata
        float duration
        integer sample_rate
        timestamp created_at
        timestamp updated_at
    }

    EMBEDDINGS {
        bigint id PK
        string embeddable_type
        bigint embeddable_id
        text content
        vector embedding_vector
        integer chunk_index
        integer usage_count
        datetime returned_at
        json metadata
        timestamp created_at
        timestamp updated_at
    }

    DOCUMENTS ||--o{ CONTENTS : has_many
    CONTENTS ||--o{ EMBEDDINGS : polymorphic
    DOCUMENTS ||--o{ EMBEDDINGS : polymorphic
</code></pre>
<h3 id="key-design-features">Key Design Features</h3>
<h4 id="single-table-inheritance-sti-for-content">Single Table Inheritance (STI) for Content</h4>
<pre><code class="language-ruby"># Content types inherit from base Content model
class Content &lt; ActiveRecord::Base
  # Base functionality for all content types
end

class TextContent &lt; Content
  # Text-specific methods and validations
end

class ImageContent &lt; Content
  # Image-specific methods and validations
end

class AudioContent &lt; Content
  # Audio-specific methods and validations
end
</code></pre>
<h4 id="polymorphic-embedding-architecture">Polymorphic Embedding Architecture</h4>
<pre><code class="language-ruby"># Embeddings can belong to any content type or document
belongs_to :embeddable, polymorphic: true

# Examples:
embedding.embeddable = text_content
embedding.embeddable = image_content
embedding.embeddable = document
</code></pre>
<h4 id="dual-metadata-system">Dual Metadata System</h4>
<ul>
<li><strong>Document.metadata</strong>: LLM-generated semantic metadata (classification, topics, etc.)</li>
<li><strong>Content.metadata</strong>: Technical file metadata (encoding, dimensions, etc.)</li>
<li><strong>Embedding.metadata</strong>: Vector processing metadata (positions, chunks, etc.)</li>
</ul>
<h2 id="core-tables">Core Tables</h2>
<p>Ragdoll uses four primary tables for data storage:</p>
<h3 id="documents-table-ragdoll_documents">Documents Table (<code>ragdoll_documents</code>)</h3>
<p>The central table for document management and LLM-generated metadata storage.</p>
<pre><code class="language-sql">CREATE TABLE ragdoll_documents (
  id                 BIGINT PRIMARY KEY,
  location           VARCHAR NOT NULL,           -- File path, URL, or identifier
  title              VARCHAR NOT NULL,           -- Human-readable title
  summary            TEXT NOT NULL DEFAULT '',  -- LLM-generated summary
  keywords           TEXT NOT NULL DEFAULT '',  -- LLM-generated keywords
  document_type      VARCHAR NOT NULL DEFAULT 'text', -- Document format
  status             VARCHAR NOT NULL DEFAULT 'pending', -- Processing status
  metadata           JSON DEFAULT '{}',         -- LLM-generated structured metadata
  file_modified_at   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  created_at         TIMESTAMP NOT NULL,
  updated_at         TIMESTAMP NOT NULL
);
</code></pre>
<h4 id="column-details">Column Details</h4>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
<th>Purpose</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>location</code></td>
<td>VARCHAR</td>
<td>Unique document identifier</td>
<td><code>/path/to/doc.pdf</code>, <code>https://example.com/file</code></td>
</tr>
<tr>
<td><code>title</code></td>
<td>VARCHAR</td>
<td>Display name for search results</td>
<td>"Machine Learning Research Paper"</td>
</tr>
<tr>
<td><code>summary</code></td>
<td>TEXT</td>
<td>LLM-generated content summary</td>
<td>"This paper explores neural networks..."</td>
</tr>
<tr>
<td><code>keywords</code></td>
<td>TEXT</td>
<td>Comma-separated keywords</td>
<td>"machine learning, AI, neural networks"</td>
</tr>
<tr>
<td><code>document_type</code></td>
<td>VARCHAR</td>
<td>Content format type</td>
<td><code>pdf</code>, <code>text</code>, <code>image</code>, <code>mixed</code></td>
</tr>
<tr>
<td><code>status</code></td>
<td>VARCHAR</td>
<td>Processing state</td>
<td><code>pending</code>, <code>processing</code>, <code>completed</code>, <code>failed</code></td>
</tr>
<tr>
<td><code>metadata</code></td>
<td>JSON</td>
<td>Structured LLM metadata</td>
<td><code>{"classification": "research", "topics": [...]}</code></td>
</tr>
<tr>
<td><code>file_modified_at</code></td>
<td>TIMESTAMP</td>
<td>Source file modification time</td>
<td>Used for change detection</td>
</tr>
</tbody>
</table>
<h4 id="relationships">Relationships</h4>
<pre><code class="language-ruby"># Document model relationships
has_many :contents, dependent: :destroy
has_many :text_contents, -&gt; { where(type: 'TextContent') }
has_many :image_contents, -&gt; { where(type: 'ImageContent') }
has_many :audio_contents, -&gt; { where(type: 'AudioContent') }
has_many :embeddings, as: :embeddable, dependent: :destroy
</code></pre>
<h4 id="status-values">Status Values</h4>
<ul>
<li><code>pending</code>: Document added but not yet processed</li>
<li><code>processing</code>: Currently being analyzed by LLM services</li>
<li><code>completed</code>: All processing finished successfully</li>
<li><code>failed</code>: Processing encountered errors</li>
<li><code>outdated</code>: Source file modified since last processing</li>
</ul>
<h3 id="contents-table-ragdoll_contents">Contents Table (<code>ragdoll_contents</code>)</h3>
<p>Single Table Inheritance (STI) table storing all content types with type-specific fields.</p>
<pre><code class="language-sql">CREATE TABLE ragdoll_contents (
  id               BIGINT PRIMARY KEY,
  type             VARCHAR NOT NULL,              -- STI discriminator
  document_id      BIGINT NOT NULL REFERENCES ragdoll_documents(id),
  embedding_model  VARCHAR NOT NULL,              -- Model for embedding generation
  content          TEXT,                          -- Text content or description
  data             TEXT,                          -- Raw file data (base64, etc.)
  metadata         JSON DEFAULT '{}',            -- Technical file metadata
  duration         FLOAT,                         -- Audio duration (seconds)
  sample_rate      INTEGER,                       -- Audio sample rate (Hz)
  created_at       TIMESTAMP NOT NULL,
  updated_at       TIMESTAMP NOT NULL
);
</code></pre>
<h4 id="content-types-sti">Content Types (STI)</h4>
<p><strong>TextContent (<code>type = 'TextContent'</code>)</strong>
- <code>content</code>: The actual text content
- <code>metadata</code>: <code>{"encoding": "UTF-8", "line_count": 150, "chunk_size": 1000}</code></p>
<p><strong>ImageContent (<code>type = 'ImageContent'</code>)</strong>
- <code>content</code>: LLM-generated image description
- <code>data</code>: Base64 encoded image data or file path
- <code>metadata</code>: <code>{"width": 1920, "height": 1080, "format": "PNG", "file_size": 2048576}</code></p>
<p><strong>AudioContent (<code>type = 'AudioContent'</code>)</strong>
- <code>content</code>: Transcribed text or audio description
- <code>data</code>: Audio file path or encoded data
- <code>duration</code>: Audio length in seconds
- <code>sample_rate</code>: Audio quality (e.g., 44100 Hz)
- <code>metadata</code>: <code>{"format": "MP3", "bitrate": 320, "channels": 2}</code></p>
<h4 id="technical-metadata-examples">Technical Metadata Examples</h4>
<pre><code class="language-json">// TextContent metadata
{
  &quot;encoding&quot;: &quot;UTF-8&quot;,
  &quot;line_count&quot;: 245,
  &quot;word_count&quot;: 1850,
  &quot;chunk_size&quot;: 1000,
  &quot;overlap&quot;: 200,
  &quot;processing_time_ms&quot;: 150
}

// ImageContent metadata
{
  &quot;width&quot;: 1920,
  &quot;height&quot;: 1080,
  &quot;format&quot;: &quot;PNG&quot;,
  &quot;file_size&quot;: 2048576,
  &quot;color_depth&quot;: 24,
  &quot;has_transparency&quot;: false,
  &quot;exif_data&quot;: {...}
}

// AudioContent metadata
{
  &quot;format&quot;: &quot;MP3&quot;,
  &quot;bitrate&quot;: 320,
  &quot;channels&quot;: 2,
  &quot;codec&quot;: &quot;LAME&quot;,
  &quot;file_size&quot;: 5242880,
  &quot;transcription_confidence&quot;: 0.95
}
</code></pre>
<h3 id="embeddings-table-ragdoll_embeddings">Embeddings Table (<code>ragdoll_embeddings</code>)</h3>
<p>Polymorphic table storing vector embeddings with usage tracking and similarity search optimization.</p>
<pre><code class="language-sql">CREATE TABLE ragdoll_embeddings (
  id                 BIGINT PRIMARY KEY,
  embeddable_type    VARCHAR NOT NULL,           -- Polymorphic type
  embeddable_id      BIGINT NOT NULL,            -- Polymorphic ID
  content            TEXT NOT NULL DEFAULT '',  -- Original text that was embedded
  embedding_vector   VECTOR(1536) NOT NULL,     -- pgvector embedding
  chunk_index        INTEGER NOT NULL,          -- Chunk ordering
  usage_count        INTEGER DEFAULT 0,         -- Search usage tracking
  returned_at        TIMESTAMP,                 -- Last usage timestamp
  metadata           JSON DEFAULT '{}',         -- Processing metadata
  created_at         TIMESTAMP NOT NULL,
  updated_at         TIMESTAMP NOT NULL
);
</code></pre>
<h4 id="vector-storage-details">Vector Storage Details</h4>
<p><strong>Embedding Vector (<code>embedding_vector</code>)</strong>
- Uses pgvector's <code>VECTOR(1536)</code> type for OpenAI embeddings
- Supports other dimensions: 768 (sentence-transformers), 4096 (large models)
- Stored as compressed binary data for performance</p>
<p><strong>Polymorphic Associations</strong></p>
<pre><code class="language-ruby"># Can belong to any content type or document
belongs_to :embeddable, polymorphic: true

# Examples:
embedding.embeddable_type = 'TextContent'
embedding.embeddable_type = 'Document'
embedding.embeddable_type = 'ImageContent'
</code></pre>
<p><strong>Usage Tracking</strong>
- <code>usage_count</code>: Incremented each time embedding appears in search results
- <code>returned_at</code>: Updated when embedding is returned in search
- Used for analytics and caching strategies</p>
<p><strong>Chunk Management</strong>
- <code>chunk_index</code>: Orders chunks within a document (0, 1, 2, ...)
- <code>content</code>: Original text chunk that was embedded
- <code>metadata</code>: Processing info like start/end positions</p>
<h4 id="embedding-metadata-examples">Embedding Metadata Examples</h4>
<pre><code class="language-json">{
  &quot;start_position&quot;: 1250,
  &quot;end_position&quot;: 2250,
  &quot;chunk_size&quot;: 1000,
  &quot;overlap&quot;: 200,
  &quot;embedding_model&quot;: &quot;openai/text-embedding-3-small&quot;,
  &quot;embedding_dimensions&quot;: 1536,
  &quot;generation_time_ms&quot;: 45,
  &quot;token_count&quot;: 180
}
</code></pre>
<h3 id="postgresql-extensions-table">PostgreSQL Extensions Table</h3>
<p>Ragdoll requires several PostgreSQL extensions enabled in the database:</p>
<pre><code class="language-sql">-- Vector similarity search (REQUIRED)
CREATE EXTENSION IF NOT EXISTS vector;

-- Text processing extensions
CREATE EXTENSION IF NOT EXISTS unaccent;  -- Remove accents
CREATE EXTENSION IF NOT EXISTS pg_trgm;   -- Trigram fuzzy search

-- UUID support
CREATE EXTENSION IF NOT EXISTS &quot;uuid-ossp&quot;;
</code></pre>
<h2 id="database-requirements">Database Requirements</h2>
<p>Ragdoll has strict database requirements for optimal performance and functionality.</p>
<h3 id="postgresql-version-requirements">PostgreSQL Version Requirements</h3>
<p><strong>Minimum Requirements:</strong>
- PostgreSQL 12+ (for JSON operators and improved indexing)
- pgvector 0.4.0+ (for vector similarity search)
- Recommended: PostgreSQL 14+ with pgvector 0.5.0+</p>
<p><strong>Version Compatibility Matrix:</strong></p>
<table>
<thead>
<tr>
<th>PostgreSQL</th>
<th>pgvector</th>
<th>Status</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>12.x</td>
<td>0.4.0+</td>
<td>✅ Supported</td>
<td>Minimum required version</td>
</tr>
<tr>
<td>13.x</td>
<td>0.4.0+</td>
<td>✅ Supported</td>
<td>Good performance</td>
</tr>
<tr>
<td>14.x</td>
<td>0.5.0+</td>
<td>✅ Recommended</td>
<td>Improved vector performance</td>
</tr>
<tr>
<td>15.x</td>
<td>0.5.0+</td>
<td>✅ Recommended</td>
<td>Best JSON performance</td>
</tr>
<tr>
<td>16.x</td>
<td>0.5.0+</td>
<td>✅ Latest</td>
<td>Latest features</td>
</tr>
</tbody>
</table>
<h3 id="required-extensions">Required Extensions</h3>
<h4 id="pgvector-extension-critical">pgvector Extension (CRITICAL)</h4>
<pre><code class="language-sql">-- Enable vector similarity search
CREATE EXTENSION IF NOT EXISTS vector;

-- Verify installation
SELECT * FROM pg_extension WHERE extname = 'vector';
</code></pre>
<p><strong>Installation Methods:</strong></p>
<pre><code class="language-bash"># Ubuntu/Debian
sudo apt-get install postgresql-14-pgvector

# macOS with Homebrew
brew install pgvector

# Docker
docker run -d --name ragdoll-postgres \
  -e POSTGRES_PASSWORD=password \
  -p 5432:5432 \
  pgvector/pgvector:pg14
</code></pre>
<h4 id="text-processing-extensions">Text Processing Extensions</h4>
<pre><code class="language-sql">-- Remove accents for better text search
CREATE EXTENSION IF NOT EXISTS unaccent;

-- Trigram similarity for fuzzy matching
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- UUID generation
CREATE EXTENSION IF NOT EXISTS &quot;uuid-ossp&quot;;
</code></pre>
<h3 id="database-configuration">Database Configuration</h3>
<h4 id="memory-settings">Memory Settings</h4>
<pre><code class="language-postgresql"># postgresql.conf optimizations
shared_buffers = 256MB                    # 25% of RAM for small instances
effective_cache_size = 1GB                # Available cache memory
work_mem = 64MB                          # Per-operation memory
maintenance_work_mem = 256MB              # Index maintenance

# Vector-specific settings
max_connections = 100                     # Adjust based on needs
random_page_cost = 1.1                   # SSD optimization
</code></pre>
<h4 id="connection-settings">Connection Settings</h4>
<pre><code class="language-yaml"># database.yml configuration
production:
  adapter: postgresql
  database: ragdoll_production
  username: ragdoll
  password: &lt;%= ENV['DATABASE_PASSWORD'] %&gt;
  host: localhost
  port: 5432
  pool: 25                                # Connection pool size
  timeout: 5000                          # Connection timeout (ms)
  prepared_statements: true              # Performance optimization
  advisory_locks: true                   # Enable advisory locking
</code></pre>
<h3 id="performance-optimization">Performance Optimization</h3>
<h4 id="vector-search-optimization">Vector Search Optimization</h4>
<pre><code class="language-sql">-- Adjust IVFFlat parameters for your dataset size
SET ivfflat.probes = 10;                 -- Search accuracy vs speed

-- Monitor vector index performance
EXPLAIN (ANALYZE, BUFFERS) 
SELECT * FROM ragdoll_embeddings 
ORDER BY embedding_vector &lt;=&gt; '[0.1,0.2,...]' 
LIMIT 10;
</code></pre>
<h4 id="json-indexing">JSON Indexing</h4>
<pre><code class="language-sql">-- Create expression indexes for frequently queried JSON fields
CREATE INDEX idx_metadata_classification 
ON ragdoll_documents USING btree ((metadata-&gt;&gt;'classification'));

CREATE INDEX idx_metadata_topics 
ON ragdoll_documents USING gin ((metadata-&gt;'topics'));
</code></pre>
<h4 id="full-text-search-optimization">Full-Text Search Optimization</h4>
<pre><code class="language-sql">-- Update full-text search statistics
ANALYZE ragdoll_documents;
ANALYZE ragdoll_contents;

-- Monitor full-text query performance
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM ragdoll_documents 
WHERE to_tsvector('english', title || ' ' || summary) 
      @@ plainto_tsquery('english', 'machine learning');
</code></pre>
<h2 id="indexing-strategy">Indexing Strategy</h2>
<p>Ragdoll uses a comprehensive indexing strategy optimized for vector similarity search, full-text search, and metadata filtering.</p>
<h3 id="vector-similarity-indexes">Vector Similarity Indexes</h3>
<h4 id="ivfflat-index-for-embeddings">IVFFlat Index for Embeddings</h4>
<pre><code class="language-sql">-- Primary vector similarity index (cosine distance)
CREATE INDEX index_ragdoll_embeddings_on_embedding_vector_cosine
ON ragdoll_embeddings 
USING ivfflat (embedding_vector vector_cosine_ops)
WITH (lists = 100);

-- Alternative: L2 distance index
CREATE INDEX index_ragdoll_embeddings_on_embedding_vector_l2
ON ragdoll_embeddings 
USING ivfflat (embedding_vector vector_l2_ops)
WITH (lists = 100);
</code></pre>
<h4 id="ivfflat-configuration">IVFFlat Configuration</h4>
<p><strong>Lists Parameter Sizing:</strong>
- Small datasets (&lt; 100K vectors): <code>lists = 100</code>
- Medium datasets (100K - 1M vectors): <code>lists = 1000</code>
- Large datasets (&gt; 1M vectors): <code>lists = sqrt(rows)</code></p>
<p><strong>Query-Time Parameters:</strong></p>
<pre><code class="language-sql">-- Adjust search accuracy vs speed
SET ivfflat.probes = 10;  -- Default: good balance
SET ivfflat.probes = 1;   -- Fastest, less accurate
SET ivfflat.probes = 50;  -- Most accurate, slower
</code></pre>
<h4 id="vector-index-maintenance">Vector Index Maintenance</h4>
<pre><code class="language-sql">-- Rebuild vector indexes after significant data changes
REINDEX INDEX index_ragdoll_embeddings_on_embedding_vector_cosine;

-- Monitor index usage
SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes 
WHERE indexname LIKE '%embedding_vector%';
</code></pre>
<h3 id="full-text-search-indexes">Full-Text Search Indexes</h3>
<h4 id="document-full-text-index">Document Full-Text Index</h4>
<pre><code class="language-sql">-- Comprehensive full-text search across multiple fields
CREATE INDEX index_ragdoll_documents_on_fulltext_search
ON ragdoll_documents 
USING gin (
  to_tsvector('english', 
    COALESCE(title, '') || ' ' ||
    COALESCE(metadata-&gt;&gt;'summary', '') || ' ' ||
    COALESCE(metadata-&gt;&gt;'keywords', '') || ' ' ||
    COALESCE(metadata-&gt;&gt;'description', '')
  )
);
</code></pre>
<h4 id="content-full-text-index">Content Full-Text Index</h4>
<pre><code class="language-sql">-- Content-specific full-text search
CREATE INDEX index_ragdoll_contents_on_fulltext_search
ON ragdoll_contents 
USING gin (to_tsvector('english', COALESCE(content, '')));
</code></pre>
<h4 id="full-text-search-usage">Full-Text Search Usage</h4>
<pre><code class="language-sql">-- Example full-text queries
SELECT * FROM ragdoll_documents 
WHERE to_tsvector('english', title || ' ' || (metadata-&gt;&gt;'summary'))
      @@ plainto_tsquery('english', 'machine learning neural networks');

-- Ranked full-text search
SELECT *, ts_rank(to_tsvector('english', title), query) as rank
FROM ragdoll_documents, plainto_tsquery('english', 'AI research') query
WHERE to_tsvector('english', title) @@ query
ORDER BY rank DESC;
</code></pre>
<h3 id="json-metadata-indexes">JSON Metadata Indexes</h3>
<h4 id="classification-and-type-indexes">Classification and Type Indexes</h4>
<pre><code class="language-sql">-- Document type filtering
CREATE INDEX index_ragdoll_documents_on_metadata_type
ON ragdoll_documents ((metadata-&gt;&gt;'document_type'));

-- Content classification filtering
CREATE INDEX index_ragdoll_documents_on_metadata_classification
ON ragdoll_documents ((metadata-&gt;&gt;'classification'));

-- Language filtering
CREATE INDEX index_ragdoll_documents_on_metadata_language
ON ragdoll_documents ((metadata-&gt;&gt;'language'));
</code></pre>
<h4 id="composite-json-indexes">Composite JSON Indexes</h4>
<pre><code class="language-sql">-- Multi-field filtering
CREATE INDEX index_ragdoll_documents_on_type_and_classification
ON ragdoll_documents (
  (metadata-&gt;&gt;'document_type'),
  (metadata-&gt;&gt;'classification')
);

-- Date-based filtering with type
CREATE INDEX index_ragdoll_documents_on_type_and_date
ON ragdoll_documents (
  (metadata-&gt;&gt;'document_type'),
  created_at
);
</code></pre>
<h4 id="array-and-complex-json-indexes">Array and Complex JSON Indexes</h4>
<pre><code class="language-sql">-- GIN index for array fields (topics, keywords)
CREATE INDEX index_ragdoll_documents_on_metadata_topics
ON ragdoll_documents USING gin ((metadata-&gt;'topics'));

CREATE INDEX index_ragdoll_documents_on_metadata_keywords_array
ON ragdoll_documents USING gin ((metadata-&gt;'keywords'));

-- JSONB path indexes for nested objects
CREATE INDEX index_ragdoll_documents_on_author_info
ON ragdoll_documents USING gin ((metadata-&gt;'author_info'));
</code></pre>
<h3 id="performance-optimized-indexes">Performance-Optimized Indexes</h3>
<h4 id="primary-key-and-foreign-key-indexes">Primary Key and Foreign Key Indexes</h4>
<pre><code class="language-sql">-- Documents table indexes
CREATE UNIQUE INDEX index_ragdoll_documents_on_location 
ON ragdoll_documents (location);  -- Unique document lookup

CREATE INDEX index_ragdoll_documents_on_status 
ON ragdoll_documents (status);    -- Processing status filtering

CREATE INDEX index_ragdoll_documents_on_document_type 
ON ragdoll_documents (document_type);  -- Document type filtering

-- Contents table indexes
CREATE INDEX index_ragdoll_contents_on_document_id 
ON ragdoll_contents (document_id);     -- Foreign key performance

CREATE INDEX index_ragdoll_contents_on_type 
ON ragdoll_contents (type);            -- STI type filtering

CREATE INDEX index_ragdoll_contents_on_embedding_model 
ON ragdoll_contents (embedding_model); -- Model-based filtering

-- Embeddings table indexes
CREATE INDEX index_ragdoll_embeddings_on_embeddable 
ON ragdoll_embeddings (embeddable_type, embeddable_id);  -- Polymorphic lookup

CREATE INDEX index_ragdoll_embeddings_on_usage_tracking 
ON ragdoll_embeddings (returned_at DESC, usage_count DESC);  -- Analytics
</code></pre>
<h4 id="composite-performance-indexes">Composite Performance Indexes</h4>
<pre><code class="language-sql">-- Multi-column indexes for common query patterns
CREATE INDEX index_ragdoll_documents_on_type_and_status 
ON ragdoll_documents (document_type, status);

CREATE INDEX index_ragdoll_contents_on_document_and_type 
ON ragdoll_contents (document_id, type);

CREATE INDEX index_ragdoll_embeddings_on_type_and_usage 
ON ragdoll_embeddings (embeddable_type, usage_count DESC);
</code></pre>
<h4 id="time-based-indexes">Time-Based Indexes</h4>
<pre><code class="language-sql">-- Chronological sorting and filtering
CREATE INDEX index_ragdoll_documents_on_created_at 
ON ragdoll_documents (created_at DESC);

CREATE INDEX index_ragdoll_documents_on_file_modified_at 
ON ragdoll_documents (file_modified_at DESC);

CREATE INDEX index_ragdoll_embeddings_on_returned_at 
ON ragdoll_embeddings (returned_at DESC) 
WHERE returned_at IS NOT NULL;
</code></pre>
<h3 id="index-maintenance-and-monitoring">Index Maintenance and Monitoring</h3>
<h4 id="index-usage-statistics">Index Usage Statistics</h4>
<pre><code class="language-sql">-- Monitor index performance
SELECT 
  schemaname,
  tablename,
  indexname,
  idx_scan as scans,
  idx_tup_read as tuples_read,
  idx_tup_fetch as tuples_fetched,
  idx_scan::float / NULLIF(seq_scan + idx_scan, 0) as index_usage_ratio
FROM pg_stat_user_indexes 
WHERE schemaname = 'public'
  AND tablename LIKE 'ragdoll_%'
ORDER BY idx_scan DESC;
</code></pre>
<h4 id="index-size-monitoring">Index Size Monitoring</h4>
<pre><code class="language-sql">-- Check index sizes
SELECT 
  indexname,
  tablename,
  pg_size_pretty(pg_relation_size(indexname::regclass)) as size
FROM pg_indexes 
WHERE schemaname = 'public'
  AND tablename LIKE 'ragdoll_%'
ORDER BY pg_relation_size(indexname::regclass) DESC;
</code></pre>
<h4 id="index-maintenance-commands">Index Maintenance Commands</h4>
<pre><code class="language-sql">-- Rebuild indexes after major data changes
REINDEX TABLE ragdoll_documents;
REINDEX TABLE ragdoll_contents;
REINDEX TABLE ragdoll_embeddings;

-- Update table statistics
ANALYZE ragdoll_documents;
ANALYZE ragdoll_contents;
ANALYZE ragdoll_embeddings;

-- Vacuum for space reclamation
VACUUM ANALYZE ragdoll_documents;
VACUUM ANALYZE ragdoll_contents;
VACUUM ANALYZE ragdoll_embeddings;
</code></pre>
<h2 id="database-migrations">Database Migrations</h2>
<p>Ragdoll includes a comprehensive migration system with automatic setup, versioning, and backward compatibility management.</p>
<h3 id="migration-files-overview">Migration Files Overview</h3>
<p>The migration system consists of four primary migration files:</p>
<ol>
<li><strong>001_enable_postgresql_extensions.rb</strong> - PostgreSQL extensions setup</li>
<li><strong>004_create_ragdoll_documents.rb</strong> - Documents table and indexes</li>
<li><strong>005_create_ragdoll_embeddings.rb</strong> - Embeddings table with vector support</li>
<li><strong>006_create_ragdoll_contents.rb</strong> - Contents table with STI architecture</li>
</ol>
<h3 id="auto-migration-feature">Auto-Migration Feature</h3>
<h4 id="automatic-database-setup">Automatic Database Setup</h4>
<pre><code class="language-ruby"># Ragdoll automatically runs migrations on first use
Ragdoll::Core.configure do |config|
  config.database_config = {
    adapter: 'postgresql',
    database: 'ragdoll_production',
    username: 'ragdoll',
    password: ENV['DATABASE_PASSWORD'],
    host: 'localhost',
    port: 5432,
    auto_migrate: true  # Enables automatic migrations
  }
end

# First client creation triggers migration
client = Ragdoll::Core.client  # Automatically sets up database
</code></pre>
<h4 id="migration-trigger-points">Migration Trigger Points</h4>
<pre><code class="language-ruby"># Auto-migration triggers
class DatabaseManager
  def self.ensure_database_ready!
    return if @database_initialized

    if Ragdoll.config.database_config[:auto_migrate]
      run_pending_migrations!
      verify_extensions!
      @database_initialized = true
    end
  end

  private

  def self.run_pending_migrations!
    ActiveRecord::Migration.verbose = true
    ActiveRecord::MigrationContext.new(migrations_path).migrate
  end
end
</code></pre>
<h3 id="manual-migration-process">Manual Migration Process</h3>
<h4 id="running-migrations-manually">Running Migrations Manually</h4>
<pre><code class="language-bash"># Using ActiveRecord migration commands
bundle exec rake db:migrate

# Run specific migration
bundle exec rake db:migrate:up VERSION=20240115000001

# Rollback migrations
bundle exec rake db:migrate:down VERSION=20240115000001

# Check migration status
bundle exec rake db:migrate:status
</code></pre>
<h4 id="custom-migration-runner">Custom Migration Runner</h4>
<pre><code class="language-ruby"># Manual migration execution
class MigrationRunner
  def self.run_all_migrations
    migration_context = ActiveRecord::MigrationContext.new(
      Rails.root.join('db', 'migrate')
    )

    migration_context.migrate
  end

  def self.rollback_to_version(version)
    migration_context = ActiveRecord::MigrationContext.new(
      Rails.root.join('db', 'migrate')
    )

    migration_context.migrate(version)
  end

  def self.migration_status
    migration_context = ActiveRecord::MigrationContext.new(
      Rails.root.join('db', 'migrate')
    )

    migration_context.migrations_status
  end
end
</code></pre>
<h3 id="schema-versioning">Schema Versioning</h3>
<h4 id="migration-version-management">Migration Version Management</h4>
<pre><code class="language-ruby"># Migration file naming convention
# YYYYMMDDHHMMSS_migration_name.rb

# 001_enable_postgresql_extensions.rb
class EnablePostgresqlExtensions &lt; ActiveRecord::Migration[7.0]
  def up
    execute &quot;CREATE EXTENSION IF NOT EXISTS vector&quot;
    execute &quot;CREATE EXTENSION IF NOT EXISTS unaccent&quot;
    execute &quot;CREATE EXTENSION IF NOT EXISTS pg_trgm&quot;
    execute &quot;CREATE EXTENSION IF NOT EXISTS \&quot;uuid-ossp\&quot;&quot;
  end

  def down
    # Extensions are rarely dropped to avoid data loss
    # execute &quot;DROP EXTENSION IF EXISTS vector CASCADE&quot;
  end
end
</code></pre>
<h4 id="schema-version-tracking">Schema Version Tracking</h4>
<pre><code class="language-sql">-- ActiveRecord schema_migrations table
CREATE TABLE schema_migrations (
  version VARCHAR PRIMARY KEY
);

-- Check current schema version
SELECT version FROM schema_migrations ORDER BY version DESC;

-- Example output:
-- 20240115000006  (006_create_ragdoll_contents)
-- 20240115000005  (005_create_ragdoll_embeddings)
-- 20240115000004  (004_create_ragdoll_documents)
-- 20240115000001  (001_enable_postgresql_extensions)
</code></pre>
<h4 id="version-compatibility-matrix">Version Compatibility Matrix</h4>
<table>
<thead>
<tr>
<th>Schema Version</th>
<th>Ragdoll Version</th>
<th>PostgreSQL</th>
<th>pgvector</th>
<th>Features</th>
</tr>
</thead>
<tbody>
<tr>
<td>001-004</td>
<td>1.0.0</td>
<td>12+</td>
<td>0.4.0+</td>
<td>Basic functionality</td>
</tr>
<tr>
<td>005</td>
<td>1.1.0</td>
<td>13+</td>
<td>0.4.0+</td>
<td>Vector embeddings</td>
</tr>
<tr>
<td>006</td>
<td>1.2.0</td>
<td>13+</td>
<td>0.5.0+</td>
<td>Multi-modal content</td>
</tr>
<tr>
<td>007+</td>
<td>2.0.0+</td>
<td>14+</td>
<td>0.5.0+</td>
<td>Advanced features</td>
</tr>
</tbody>
</table>
<h3 id="backward-compatibility">Backward Compatibility</h3>
<h4 id="migration-safety-features">Migration Safety Features</h4>
<pre><code class="language-ruby"># Safe migration practices in Ragdoll
class SafeMigrationBase &lt; ActiveRecord::Migration[7.0]
  # Disable DDL transactions for extension creation
  disable_ddl_transaction!

  def safe_add_column(table, column, type, options = {})
    # Add column with default to avoid locks on large tables
    add_column table, column, type, options.merge(default: options[:default])

    # Remove default after column is added (if temporary)
    if options[:temporary_default]
      change_column_default table, column, nil
    end
  end

  def safe_add_index(table, columns, options = {})
    # Use concurrent index creation for large tables
    options[:algorithm] = :concurrently
    add_index table, columns, options
  end
end
</code></pre>
<h4 id="data-migration-strategies">Data Migration Strategies</h4>
<pre><code class="language-ruby"># Data-safe migration example
class AddNewMetadataFields &lt; ActiveRecord::Migration[7.0]
  def up
    # Add new columns with defaults
    add_column :ragdoll_documents, :new_field, :string, default: ''

    # Migrate existing data in batches
    Document.find_in_batches(batch_size: 1000) do |batch|
      batch.each do |document|
        document.update_column(:new_field, migrate_old_data(document))
      end
    end
  end

  def down
    remove_column :ragdoll_documents, :new_field
  end

  private

  def migrate_old_data(document)
    # Safe data transformation logic
    document.old_field&amp;.transform_data || ''
  end
end
</code></pre>
<h4 id="rollback-safety">Rollback Safety</h4>
<pre><code class="language-ruby"># Reversible migration patterns
class ReversibleMigration &lt; ActiveRecord::Migration[7.0]
  def change
    # Automatically reversible operations
    create_table :new_table do |t|
      t.string :name, null: false
      t.timestamps
    end

    add_index :new_table, :name
  end

  # For complex operations requiring explicit rollback
  def up
    # Forward migration
    execute &quot;CREATE MATERIALIZED VIEW complex_view AS ...&quot;
  end

  def down
    # Explicit rollback
    execute &quot;DROP MATERIALIZED VIEW IF EXISTS complex_view&quot;
  end
end
</code></pre>
<h3 id="migration-best-practices">Migration Best Practices</h3>
<h4 id="development-workflow">Development Workflow</h4>
<pre><code class="language-bash"># 1. Create new migration
rails generate migration AddFeatureToDocuments feature:string

# 2. Edit migration file with safe practices
# 3. Test migration on development data
bundle exec rake db:migrate

# 4. Test rollback
bundle exec rake db:rollback

# 5. Re-run migration
bundle exec rake db:migrate

# 6. Commit migration file
git add db/migrate/*
git commit -m &quot;Add feature column to documents&quot;
</code></pre>
<h4 id="production-deployment">Production Deployment</h4>
<pre><code class="language-bash"># Production migration checklist:
# 1. Backup database
pg_dump ragdoll_production &gt; backup_$(date +%Y%m%d_%H%M%S).sql

# 2. Run migration with monitoring
time bundle exec rake db:migrate

# 3. Verify data integrity
bundle exec rake db:migrate:status

# 4. Test application functionality
curl -f http://localhost:3000/health

# 5. Monitor performance
psql -c &quot;SELECT * FROM pg_stat_activity WHERE state = 'active';&quot;
</code></pre>
<h4 id="emergency-rollback-procedures">Emergency Rollback Procedures</h4>
<pre><code class="language-bash"># If migration causes issues:
# 1. Stop application
sudo systemctl stop ragdoll

# 2. Rollback migration
bundle exec rake db:rollback

# 3. Restore from backup if needed
psql ragdoll_production &lt; backup_20240115_120000.sql

# 4. Restart application
sudo systemctl start ragdoll

# 5. Investigate and fix migration
</code></pre>
<h2 id="database-maintenance">Database Maintenance</h2>
<h3 id="regular-maintenance-tasks">Regular Maintenance Tasks</h3>
<h4 id="vacuum-and-analyze">Vacuum and Analyze</h4>
<pre><code class="language-sql">-- Weekly maintenance routine
VACUUM ANALYZE ragdoll_documents;
VACUUM ANALYZE ragdoll_contents;
VACUUM ANALYZE ragdoll_embeddings;

-- Full vacuum (monthly, during low usage)
VACUUM FULL ragdoll_embeddings;  -- Reclaim space from deleted vectors
</code></pre>
<h4 id="index-maintenance">Index Maintenance</h4>
<pre><code class="language-sql">-- Rebuild vector indexes after significant changes
REINDEX INDEX index_ragdoll_embeddings_on_embedding_vector_cosine;

-- Update statistics for query planner
ANALYZE ragdoll_embeddings;
</code></pre>
<h4 id="performance-monitoring">Performance Monitoring</h4>
<pre><code class="language-sql">-- Monitor slow queries
SELECT query, mean_exec_time, calls, total_exec_time
FROM pg_stat_statements 
WHERE query LIKE '%ragdoll_%'
ORDER BY mean_exec_time DESC
LIMIT 10;

-- Check index usage
SELECT indexname, idx_scan, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes 
WHERE tablename LIKE 'ragdoll_%'
ORDER BY idx_scan DESC;
</code></pre>
<h3 id="backup-and-recovery">Backup and Recovery</h3>
<h4 id="backup-strategy">Backup Strategy</h4>
<pre><code class="language-bash"># Full database backup
pg_dump -Fc ragdoll_production &gt; ragdoll_backup_$(date +%Y%m%d).dump

# Schema-only backup
pg_dump -s ragdoll_production &gt; ragdoll_schema_$(date +%Y%m%d).sql

# Data-only backup
pg_dump -a ragdoll_production &gt; ragdoll_data_$(date +%Y%m%d).sql
</code></pre>
<h4 id="recovery-procedures">Recovery Procedures</h4>
<pre><code class="language-bash"># Restore full database
pg_restore -d ragdoll_production ragdoll_backup_20240115.dump

# Restore specific table
pg_restore -d ragdoll_production -t ragdoll_embeddings ragdoll_backup_20240115.dump
</code></pre>
<hr />
<p><em>This document is part of the Ragdoll documentation suite. For immediate help, see the <a href="../quick-start/">Quick Start Guide</a> or <a href="../api-client/">API Reference</a>.</em></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  </body>
</html>